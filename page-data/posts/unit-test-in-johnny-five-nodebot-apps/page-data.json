{"componentChunkName":"component---src-templates-post-js","path":"/posts/unit-test-in-johnny-five-nodebot-apps/","result":{"data":{"markdownRemark":{"html":"<p>This time something simple, but without good information about it is how to add unit tests in Nodebots apps.</p>\n<blockquote>\n<p>Unit test? But this is not a new thing</p>\n</blockquote>\n<p>Yes, you’re right, but you can find few contents about this topic in Arduino, robots and open hardware apps.</p>\n<p>But relax … this is not a big deal ;)</p>\n<h3>Unit tests</h3>\n<p>Unit test is only one way to test your software. Based in the <a href=\"http://martinfowler.com/bliki/TestPyramid.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">test pyramid</a> this is the way that you can organize the tests your application.</p>\n<p><img src=\"https://cdn-images-1.medium.com/max/800/0*3njsTEPjz8qom_kl.png\" alt=\"\"></p>\n<blockquote>\n<p><em>In this post we will talk only of unit tests, if you like to know more about all the layers, please read</em> <a href=\"http://martinfowler.com/bliki/TestPyramid.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><em>“TestPyramid” post of Martin Fowler</em></a></p>\n</blockquote>\n<p>The idea of the unit test is validate your code, make sure that your code is doing what it suppose to do and give you feedback about the errors fast (before your deploy pipeline steps) when the assertion fails.</p>\n<p>The validation of this concept was in the <a href=\"https://github.com/willmendesneto/build-checker\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Build Checker repository</a> and was really easy.</p>\n<blockquote>\n<p><em>If you like to know more about the project, please read</em> <a href=\"http://willmendesneto.github.io/2016/05/15/checking-your-build-in-snap-ci-via-nodebots-using-nodejs-and-arduino\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><em>“Checking your build in SNAP-CI via nodebots using NodeJS and Arduino”</em></a></p>\n</blockquote>\n<h3>What about nodebots?</h3>\n<p>One aspect that nobody explain very well is about the tests in nodebots. The main goal in this case is create the electric mocks and stubs and simulate the communication between components.</p>\n<p>One useful package is <a href=\"https://github.com/rwaldron/mock-firmata\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">mock-firmata</a>, created by Rick Waldron to make the tests in <a href=\"http://johnny-five.io\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Johnny-Five</a> easier. The integration is really simple, you just need to load and create your board component in the test.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> mockFirmata <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mock-firmata'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> five <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'johnny-five'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> Board <span class=\"token operator\">=</span> five<span class=\"token punctuation\">.</span>Board<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> Accelerometer <span class=\"token operator\">=</span> five<span class=\"token punctuation\">.</span>Accelerometer<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> board <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Board</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">io</span><span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">mockFirmata<span class=\"token punctuation\">.</span>Firmata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">debug</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">repl</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>After the integration, the unit tests is using mocha test framework (but you can use others, if you like), <a href=\"http://sinonjs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">sinon js</a> in test spies, stubs and mocks and <a href=\"https://shouldjs.github.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">should js</a> for the assertions.</p>\n<p>One simple way to validation is when the build checker should blink the led. Basically you have to create a stub for the request (in this case using <a href=\"https://github.com/request/request\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">request package</a>) for validate the response by expected types (success and error) and spy the led components.</p>\n<p>After this is create the scenario for validate this case. Nothing really hard, right? Some things that you need to remember about the test is that your beforeEach method should be a documentation about the steps to reproduce your scenario.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> request <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'request'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> sinon <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sinon'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">...</span>\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'When the CI server send success response'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    successResponseCI <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">your awesome response</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clock <span class=\"token operator\">=</span> sinon<span class=\"token punctuation\">.</span><span class=\"token function\">useFakeTimers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sinon<span class=\"token punctuation\">.</span><span class=\"token function\">stub</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> <span class=\"token string\">'get'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">yields</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> successResponseCI<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sinon<span class=\"token punctuation\">.</span><span class=\"token function\">spy</span><span class=\"token punctuation\">(</span>buildChecker<span class=\"token punctuation\">.</span>ledSuccess<span class=\"token punctuation\">,</span> <span class=\"token string\">'on'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    sinon<span class=\"token punctuation\">.</span><span class=\"token function\">spy</span><span class=\"token punctuation\">(</span>buildChecker<span class=\"token punctuation\">.</span>ledError<span class=\"token punctuation\">,</span> <span class=\"token string\">'off'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    buildChecker<span class=\"token punctuation\">.</span><span class=\"token function\">startPolling</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clock<span class=\"token punctuation\">.</span><span class=\"token function\">tick</span><span class=\"token punctuation\">(</span><span class=\"token constant\">CONFIG</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INTERVAL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">afterEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    request<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">.</span><span class=\"token function\">restore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clock<span class=\"token punctuation\">.</span><span class=\"token function\">restore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should turn on the success led'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    buildChecker<span class=\"token punctuation\">.</span>ledSuccess<span class=\"token punctuation\">.</span>on<span class=\"token punctuation\">.</span>calledOnce<span class=\"token punctuation\">.</span>should<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should turn off the error led'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    buildChecker<span class=\"token punctuation\">.</span>ledError<span class=\"token punctuation\">.</span>off<span class=\"token punctuation\">.</span>calledOnce<span class=\"token punctuation\">.</span>should<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>After this you can add more tests and create your pipeline correctly, so you are sure that your code is covered. The final result is :</p>\n<p><img src=\"https://cdn-images-1.medium.com/max/800/0*Guw1r56Nwz6N0E0n.png\" alt=\"\"></p>\n<p>*** This don’t remove other validations, as validation with software, but it’s another way to validate first the new features, updates, etc.</p>\n<blockquote>\n<p>If you like to know more about Nodebots, please check my book <a href=\"https://leanpub.com/nodebots-javascript-and-robotic-in-the-real-world\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">“Nodebots — Javascript and robotic in the real world”</a></p>\n</blockquote>\n<hr/>\n<h3>Conclusion</h3>\n<p>As you can see the integration with unit tests is really easy and you can make sure that at least these cases are covered in your app. In this repository is integrated code coverage badge, code lint and more.</p>\n<p>How about you? How you are using node js and unit tests? Are you testing your node js embedded applications? Share your experience!</p>\n<p>Thank you and see you soon!</p>\n<p>Links:</p>\n<ul>\n<li>Johnny-Five: <a href=\"http://johnny-five.io\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://johnny-five.io</a></li>\n<li>Test pyramid: <a href=\"http://martinfowler.com/bliki/TestPyramid.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://martinfowler.com/bliki/TestPyramid.html</a></li>\n<li>Mock Firmata: <a href=\"https://github.com/rwaldron/mock-firmata\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/rwaldron/mock-firmata</a></li>\n<li>Build Checker: <a href=\"https://github.com/willmendesneto/build-checker\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/willmendesneto/build-checker</a></li>\n<li>Sinon JS: <a href=\"http://sinonjs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://sinonjs.org/</a></li>\n<li>Should JS: <a href=\"https://shouldjs.github.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://shouldjs.github.io/</a></li>\n<li>Mocha JS: <a href=\"https://mochajs.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://mochajs.org/</a></li>\n</ul>","frontmatter":{"date":"June 27, 2016","path":"/posts/unit-test-in-johnny-five-nodebot-apps","title":"Unit test in Johnny-Five nodebot apps","tags":["nodejs","nodebots","javascript","tests"],"status":"active"},"timeToRead":3}},"pageContext":{"postPath":"/posts/unit-test-in-johnny-five-nodebot-apps"}},"staticQueryHashes":["1271460761","63159454"],"slicesMap":{}}